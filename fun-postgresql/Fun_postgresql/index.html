<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Fun_postgresql (fun-postgresql.Fun_postgresql)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../index.html">fun-postgresql</a> &#x00BB; Fun_postgresql</nav><header class="odoc-preamble"><h1>Module <code><span>Fun_postgresql</span></code></h1><p>Use this module for PostgreSQL database queries.</p><p>Note: does not support <code>batch_insert</code> out of the box because PostgreSQL uses numbered placeholders, which makes it much more difficult to parse out and modify the insert query with the correct number of placeholders.</p></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../fun-sql/Fun_sql/module-type-Query_sig/index.html">Fun_sql.Query_sig</a>
  <span class="keyword">with</span> <span><span class="keyword">type</span> <span>('row, 'r) <a href="../../fun-sql/Fun_sql/module-type-Query_sig/index.html#type-ret">ret</a></span> = <span><span>(<span class="type-var">'row</span>, <span class="type-var">'r</span>)</span> <a href="../../fun-sql/Fun_sql/Query/index.html#type-ret">Fun_sql.Query.ret</a></span></span></span></code></summary><h3 id="database-agnostic-query-helpers"><a href="#database-agnostic-query-helpers" class="anchor"></a>Database-agnostic query helpers</h3><div class="odoc-spec"><div class="spec value anchored" id="val-sql"><a href="#val-sql" class="anchor"></a><code><span><span class="keyword">val</span> sql : <span><span><span>(<span class="type-var">'a</span>, <span class="xref-unresolved">Stdlib</span>.Format.formatter, unit, string)</span> <span class="xref-unresolved">Stdlib</span>.format4</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Convenience for formatting query strings with placeholders. Eg</p><pre class="language-ocaml"><code>sql &quot;select name from people where id = %a&quot; placeholder 0</code></pre></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ret"><a href="#type-ret" class="anchor"></a><code><span><span class="keyword">type</span> <span>('row, 'r) ret</span></span><span> = <span><span>(<span class="type-var">'row</span>, <span class="type-var">'r</span>)</span> <a href="../../fun-sql/Fun_sql/Query/index.html#type-ret">Fun_sql.Query.ret</a></span></span></code></div><div class="spec-doc"><p>A decoder of a single row of the resultset from running a query.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unit"><a href="#val-unit" class="anchor"></a><code><span><span class="keyword">val</span> unit : <span><span>(<span class="type-var">'row</span>, unit)</span> <a href="#type-ret">ret</a></span></span></code></div><div class="spec-doc"><p><code>unit</code> indicates that the query doesn't return any meaningful output.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ret"><a href="#val-ret" class="anchor"></a><code><span><span class="keyword">val</span> ret : <span><span>(<span><span class="type-var">'row</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'row</span>, <span><span class="type-var">'r</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span>)</span> <a href="#type-ret">ret</a></span></span></code></div><div class="spec-doc"><p><code>ret decode</code> is a custom return type encoding for a resultset into a sequence of values of the type decoded by <code>decode</code>.</p><p><code>decode</code> constructs a value of the custom type if possible, else raises <code>Failure</code>.</p><p>Note that the sequence rows of the resultset is unfolded as it is read from the database. It can only be traversed <i>once,</i> with e.g. <code>List.of_seq</code> or <code>Seq.iter</code>. If traversed multiple times, it will raise <code>Failure</code>.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if any row cannot be decoded.</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Failure</code> <p>if an unexpected result code is encountered.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-one"><a href="#val-one" class="anchor"></a><code><span><span class="keyword">val</span> one : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-all"><a href="#val-all" class="anchor"></a><code><span><span class="keyword">val</span> all : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span></span></code></div></div></details></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../fun-sql/Fun_sql/module-type-Sql/index.html">Fun_sql.Sql</a>
  <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../fun-sql/Fun_sql/module-type-Sql/index.html#type-db">db</a> = <span class="xref-unresolved">Postgresql</span>.connection</span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../fun-sql/Fun_sql/module-type-Sql/index.html#type-arg">arg</a> = string</span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../fun-sql/Fun_sql/module-type-Sql/index.html#type-row">row</a> = <span>string array</span></span></span></code></summary><h3 id="database-specific-definitions"><a href="#database-specific-definitions" class="anchor"></a>Database-specific definitions</h3><div class="odoc-spec"><div class="spec type anchored" id="type-db"><a href="#type-db" class="anchor"></a><code><span><span class="keyword">type</span> db</span><span> = <span class="xref-unresolved">Postgresql</span>.connection</span></code></div><div class="spec-doc"><p>The database connection or file, etc.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-arg"><a href="#type-arg" class="anchor"></a><code><span><span class="keyword">type</span> arg</span><span> = string</span></code></div><div class="spec-doc"><p>A value sent to the database in the place of a query parameter.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-row"><a href="#type-row" class="anchor"></a><code><span><span class="keyword">type</span> row</span><span> = <span>string array</span></span></code></div><div class="spec-doc"><p>A tuple from the database.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-placeholder"><a href="#val-placeholder" class="anchor"></a><code><span><span class="keyword">val</span> placeholder : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>A generic way to write placeholders for different database drivers' prepared statement parameters.</p><p>ℹ️ Placeholders are 0-indexed.</p></div></div><h3 id="query-runners"><a href="#query-runners" class="anchor"></a>Query runners</h3><div class="odoc-spec"><div class="spec value anchored" id="val-query"><a href="#val-query" class="anchor"></a><code><span><span class="keyword">val</span> query : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-arg">arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-row">row</a>, <span class="type-var">'r</span>)</span> <a href="../../fun-sql/Fun_sql/Query/index.html#type-ret">Fun_sql.Query.ret</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p>The main function through which queries are run is the <code>query</code> function. This function <em>always</em> creates a prepared statement for each partial call to <code>query db sql</code>. This prepared statement can then be called with the actual arguments (if any) and the resultset row decoder:</p><pre class="language-ocaml"><code>let add_person =
  query db (sql &quot;insert into people (name, age) values (%a, %a)&quot; placeholder 0 placeholder 1)
let add_person name age = add_person Arg.[text name; int age] unit</code></pre><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if trying to create multiple prepared statements for the same SQL query in PostgreSQL. To avoid this, just create the prepared statement <em>once only</em> and call it whenever needed, as shown above.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-exec_script"><a href="#val-exec_script" class="anchor"></a><code><span><span class="keyword">val</span> exec_script : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>exec_script db sql</code> executes the <code>sql</code> script (possibly made up of multiple statements) in the database <code>db</code>. Note that it ignores any rows returned by any of the statements.</p><p>The script <i>must not</i> have a trailing semicolon.</p></div></div><h3 id="binding-arguments"><a href="#binding-arguments" class="anchor"></a>Binding arguments</h3><p>These encode OCaml data as data to be bound to the query statement.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Arg"><a href="#module-Arg" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Arg/index.html">Arg</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h4 id="helpers-to-get-typed-values-from-columns"><a href="#helpers-to-get-typed-values-from-columns" class="anchor"></a>Helpers to get typed values from columns</h4><div class="odoc-spec"><div class="spec value anchored" id="val-int"><a href="#val-int" class="anchor"></a><code><span><span class="keyword">val</span> int : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bool"><a href="#val-bool" class="anchor"></a><code><span><span class="keyword">val</span> bool : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-int64"><a href="#val-int64" class="anchor"></a><code><span><span class="keyword">val</span> int64 : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> int64</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-float"><a href="#val-float" class="anchor"></a><code><span><span class="keyword">val</span> float : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-text"><a href="#val-text" class="anchor"></a><code><span><span class="keyword">val</span> text : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Also handles values of all other types. Use this when SQLite can change the exact type of value it returns at runtime, e.g. for very large numbers it can return text.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-opt"><a href="#val-opt" class="anchor"></a><code><span><span class="keyword">val</span> opt : <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>opt dec col row</code> is the optional value <code>NULL</code> turns to <code>None</code> at column <code>col</code> of the result <code>row</code>.</p></div></div></details></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../fun-sql/Fun_sql/module-type-S/index.html">Fun_sql.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../fun-sql/Fun_sql/module-type-S/index.html#type-db">db</a> := <a href="#type-db">db</a></span> <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../fun-sql/Fun_sql/module-type-S/index.html#type-arg">arg</a> := <a href="#type-arg">arg</a></span></span></code></summary><h3 id="higher-level-utilities-that-work-across-supported-dbs"><a href="#higher-level-utilities-that-work-across-supported-dbs" class="anchor"></a>Higher-level utilities that work across supported DBs</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Bad_migration"><a href="#exception-Bad_migration" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Bad_migration</span> <span class="keyword">of</span> string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-migrate"><a href="#val-migrate" class="anchor"></a><code><span><span class="keyword">val</span> migrate : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>migrate db dir</code> applies the SQL migration scripts in <code>dir</code> on the given database <code>db</code>, keeping track of those that have already been applied.</p><p>To apply the migrations in the correct order, the migration scripts must be given filenames that are sorted in lexicographical order of the desired migration order, e.g. <code>0000_0001_init.sql</code> will be applied before <code>0000_0002_sec.sql</code>, and so on.</p><p>Note that this uses <code>exec_script</code> internally, which means the migration scripts <i>must not</i> have trailing semicolons either.</p><p>Any files with extensions other than <code>.sql</code> are ignored.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Bad_migration"><code>Bad_migration</code></a> <p>an error occurs during applying the migrations.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transaction"><a href="#val-transaction" class="anchor"></a><code><span><span class="keyword">val</span> transaction : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p><code>transaction db f</code> runs <code>f ()</code> inside a transaction in the <code>db</code>. If the operation succeeds, it commits the transaction and returns its result. If it fails with an exception, it rolls back the transaction and re-raises the exception.</p></div></div></details></div></div></body></html>
