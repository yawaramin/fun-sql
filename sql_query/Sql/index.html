<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sql (sql_query.Sql)</title><link rel="stylesheet" href="../../_odoc_support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../_odoc_support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">sql_query</a> &#x00BB; Sql</nav><header class="odoc-preamble"><h1>Module <code><span>Sql</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#convenience-types-for-prepared-statements">Convenience types for prepared statements</a></li><li><a href="#query-runners">Query runners</a></li><li><a href="#binding-arguments">Binding arguments</a></li><li><a href="#return-types">Return types</a><ul><li><a href="#helpers-to-get-typed-values-from-columns">Helpers to get typed values from columns</a></li><li><a href="#helpers-to-deal-with-resultset-sequences">Helpers to deal with resultset sequences</a></li></ul></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-db"><a href="#type-db" class="anchor"></a><code><span><span class="keyword">type</span> db</span><span> = <span class="xref-unresolved">Sqlite3</span>.db</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-arg"><a href="#type-arg" class="anchor"></a><code><span><span class="keyword">type</span> arg</span><span> = <span class="xref-unresolved">Sqlite3</span>.Data.t</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ret"><a href="#type-ret" class="anchor"></a><code><span><span class="keyword">type</span> <span>_ ret</span></span></code></div></div><h3 id="convenience-types-for-prepared-statements"><a href="#convenience-types-for-prepared-statements" class="anchor"></a>Convenience types for prepared statements</h3><div class="odoc-spec"><div class="spec type anchored" id="type-dql"><a href="#type-dql" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a dql</span></span><span> = <span>?args:<span><a href="#type-arg">arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <a href="#type-ret">ret</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span></span></code></div><div class="spec-doc"><p>Represents a Data Query Language query. Note, update statements can also return results nowadays so technically this naming is slightly inaccurate.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-dml"><a href="#type-dml" class="anchor"></a><code><span><span class="keyword">type</span> dml</span><span> = <span>?args:<span><a href="#type-arg">arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="#type-ret">ret</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Represents a Data Modification Language query.</p></div></div><h3 id="query-runners"><a href="#query-runners" class="anchor"></a>Query runners</h3><div class="odoc-spec"><div class="spec value anchored" id="val-query"><a href="#val-query" class="anchor"></a><code><span><span class="keyword">val</span> query : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>?args:<span><a href="#type-arg">arg</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'r</span> <a href="#type-ret">ret</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p><code>query db sql ?args ret</code> executes a query <code>sql</code> against the database <code>db</code>. The arguments to be bound to the query, if any, are passed in <code>args</code>. The return value of the query, if any, is decoded by <code>ret</code>.</p><p>Note, this function is designed so you can prepare each SQL statement only once, and run it each time with different parameters if needed. This may give you an efficiency boost over preparing the statement each time:</p><pre class="language-ocaml"><code>let create_user = query db &quot;insert into users (name, age) values (?, ?)&quot;
let create_user name age = create_user ~args:Arg.[text name; int age] unit </code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-batch_insert"><a href="#val-batch_insert" class="anchor"></a><code><span><span class="keyword">val</span> batch_insert : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-arg">arg</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'r</span> <a href="#type-ret">ret</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p><code>batch_insert db sql objs obj_args ret</code> inserts into the database <code>db</code>, running the query <code>sql</code>, the row tuples obtained by encoding the list of <code>objs</code> using the <code>obj_args</code> function.</p><p>This prepares a new statement each time because the <code>VALUES (...)</code> clause may contain different numbers of placeholders in each call.</p><p>The return type of the query is decoded by <code>ret</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-exec_script"><a href="#val-exec_script" class="anchor"></a><code><span><span class="keyword">val</span> exec_script : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>exec_script db sql</code> executes the <code>sql</code> script (possibly made up of multiple statements) in the database <code>db</code>. Note that it ignores any rows returned by any of the statements.</p><p>The script <i>must not</i> have a trailing semicolon.</p></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Bad_migration"><a href="#exception-Bad_migration" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Bad_migration</span> <span class="keyword">of</span> string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-migrate"><a href="#val-migrate" class="anchor"></a><code><span><span class="keyword">val</span> migrate : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>migrate db dir</code> applies the SQL migration scripts in <code>dir</code> on the given database <code>db</code>, keeping track of those that have already been applied.</p><p>To apply the migrations in the correct order, the migration scripts must be given filenames that are sorted in lexicographical order of the desired migration order, e.g. <code>0000_0001_init.sql</code> will be applied before <code>0000_0002_sec.sql</code>, and so on.</p><p>Note that this uses <code>exec_script</code> internally, which means the migration scripts <i>must not</i> have trailing semicolons either.</p><p>Any files with extensions other than <code>.sql</code> are ignored.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Bad_migration</span> <p>an error occurs during applying the migrations.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transaction"><a href="#val-transaction" class="anchor"></a><code><span><span class="keyword">val</span> transaction : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p><code>transaction db f</code> runs <code>f ()</code> inside a transaction in the <code>db</code>. If the operation succeeds, it commits the transaction and returns its result. If it fails with an exception, it rolls back the transaction and re-raises the exception.</p></div></div><h3 id="binding-arguments"><a href="#binding-arguments" class="anchor"></a>Binding arguments</h3><p>These encode OCaml data as data to be bound to the query statement.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Arg"><a href="#module-Arg" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Arg/index.html">Arg</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="return-types"><a href="#return-types" class="anchor"></a>Return types</h3><div class="odoc-spec"><div class="spec type anchored" id="type-row"><a href="#type-row" class="anchor"></a><code><span><span class="keyword">type</span> row</span><span> = <span><span class="xref-unresolved">Sqlite3</span>.Data.t array</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unit"><a href="#val-unit" class="anchor"></a><code><span><span class="keyword">val</span> unit : <span>unit <a href="#type-ret">ret</a></span></span></code></div><div class="spec-doc"><p><code>unit</code> indicates that the query doesn't return any meaningful output.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ret"><a href="#val-ret" class="anchor"></a><code><span><span class="keyword">val</span> ret : <span><span>(<span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <a href="#type-ret">ret</a></span></span></code></div><div class="spec-doc"><p><code>ret decode</code> is a custom return type encoding for a resultset into a sequence of values of the type decoded by <code>decode</code>.</p><p><code>decode</code> constructs a value of the custom type if possible, else raises <code>Failure</code>.</p><p>Note that the sequence rows of the resultset is unfolded as it is read from the database. It can only be traversed <i>once,</i> with e.g. <code>List.of_seq</code> or <code>Seq.iter</code>. If traversed multiple times, it will raise <code>Failure</code>.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Invalid_argument</span> <p>if any row cannot be decoded.</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Failure</span> <p>if an unexpected result code is encountered.</p></li></ul></div></div><h4 id="helpers-to-get-typed-values-from-columns"><a href="#helpers-to-get-typed-values-from-columns" class="anchor"></a>Helpers to get typed values from columns</h4><div class="odoc-spec"><div class="spec value anchored" id="val-int"><a href="#val-int" class="anchor"></a><code><span><span class="keyword">val</span> int : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bool"><a href="#val-bool" class="anchor"></a><code><span><span class="keyword">val</span> bool : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-int64"><a href="#val-int64" class="anchor"></a><code><span><span class="keyword">val</span> int64 : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> int64</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-float"><a href="#val-float" class="anchor"></a><code><span><span class="keyword">val</span> float : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-text"><a href="#val-text" class="anchor"></a><code><span><span class="keyword">val</span> text : <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Also handles values of all other types. Use this when SQLite can change the exact type of value it returns at runtime, e.g. for very large numbers it can return text.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-opt"><a href="#val-opt" class="anchor"></a><code><span><span class="keyword">val</span> opt : <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-row">row</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>opt dec col row</code> is the optional value <code>NULL</code> turns to <code>None</code> at column <code>col</code> of the result <code>row</code>.</p></div></div><h4 id="helpers-to-deal-with-resultset-sequences"><a href="#helpers-to-deal-with-resultset-sequences" class="anchor"></a>Helpers to deal with resultset sequences</h4><div class="odoc-spec"><div class="spec exception anchored" id="exception-More_than_one"><a href="#exception-More_than_one" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">More_than_one</span></span></code></div><div class="spec-doc"><p>Thrown if we are expecting at most one result but get more.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-only"><a href="#val-only" class="anchor"></a><code><span><span class="keyword">val</span> only : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>only seq</code> is the first and only element of <code>seq</code>. This is a convenience function because all queries return seqs but sometimes we want only a single item, otherwise it should be an error.</p><p>Use this in preference to calculating the length of the <code>seq</code>, which would force the entire data structure.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Not_found</span> <p>if <code>seq</code> has 0 items.</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">More_than_one</span> <p>if <code>seq</code> has more than 1 item.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-optional"><a href="#val-optional" class="anchor"></a><code><span><span class="keyword">val</span> optional : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>optional seq</code> is <code>Some a</code> if <code>a</code> is the first and only element of <code>seq</code>, or <code>None</code> if <code>seq</code> is empty.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">More_than_one</span> <p>if <code>seq</code> has more than 1 item.</p></li></ul></div></div></div></body></html>